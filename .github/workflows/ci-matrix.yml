name: Extension CI

on:
  push:
    paths:
      - 'equed-*/**'
  pull_request:
    paths:
      - 'equed-*/**'

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          EXTENSIONS=$(find . -maxdepth 1 -type d -name 'equed-*' -printf '%f\n' | jq -R -s -c 'split("\n") | map(select(length>0))')
          echo "matrix=$EXTENSIONS" >> "$GITHUB_OUTPUT"

  test:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      matrix:
        extension: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: xml, gd
          coverage: none
      - name: Install dependencies
        run: composer install --no-interaction --prefer-dist
        working-directory: ${{ matrix.extension }}
      - name: Run PHPStan
        continue-on-error: true
        run: |
          if [ -f vendor/bin/phpstan ]; then
            echo "ðŸ” Running PHPStan..."
            vendor/bin/phpstan analyse --error-format=sarif > phpstan.sarif || echo "âš ï¸ PHPStan failed â€“ check baseline"
          else
            echo "â„¹ï¸ PHPStan not installed"
            echo '{}' > phpstan.sarif
          fi
        working-directory: ${{ matrix.extension }}
      - name: Upload PHPStan report
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ matrix.extension }}/phpstan.sarif
      - name: Run PHPUnit
        continue-on-error: true
        run: |
          if [ -d tests ] || [ -d Tests ]; then
            vendor/bin/phpunit
          else
            echo 'No PHPUnit tests found'
          fi
        working-directory: ${{ matrix.extension }}
